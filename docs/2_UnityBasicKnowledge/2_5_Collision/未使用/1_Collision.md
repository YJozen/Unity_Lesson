# Collision（衝突）

コリジョンは物理エンジンの中心的な機能の一つで、ゲームオブジェクト同士の相互作用を管理します。  
以下に、コリジョンの基本概念、コリジョンの設定、コリジョンイベント、最適化、トラブルシューティングなどを詳しく説明します。

<br>

# 1. コリジョンの基本概念

- **コリジョン（Collision）**:  
ゲームオブジェクト同士が接触した際の状態を指します。これにより、物理的な反応やゲーム内のイベントをトリガーすることができます。

- **トリガー（Trigger）**:  
コリジョンが発生した際に特定のイベントを発生させるために使用される特別なコリジョンボックスです。トリガーは他のオブジェクトと衝突しますが、物理的な反応（衝突の反発など）はありません。

- **物理エンジン**:  
UnityはNVIDIAのPhysXを使用して物理シミュレーションを行います。これにより、オブジェクトの動きや衝突の処理が行われます。

<br>

# 2. コリジョンの設定

## 2.1. Colliderの追加

コリジョンを管理するためには、ゲームオブジェクトに**Collider**コンポーネントを追加する必要があります。Colliderにはさまざまな種類がありますが、以下のものが一般的です。

- **Box Collider**: 四角い形状のコリジョンを作成します。
- **Sphere Collider**: 球形のコリジョンを作成します。
- **Capsule Collider**: カプセル形状のコリジョンを作成します。
- **Mesh Collider**: 任意のメッシュに基づいたコリジョンを作成します。特に複雑な形状に適しています。


試しに下記のようなCube.objを用意し、Colliderコンポーネントを設定してください。

```obj
# Simple Cube
o Cube

v -0.5 -0.5 -0.5
v 0.5 -0.5 -0.5
v 0.5 0.5 -0.5
v -0.5 0.5 -0.5
v -0.5 -0.5 0.5
v 0.5 -0.5 0.5
v 0.5 0.5 0.5
v -0.5 0.5 0.5

# Normals
vn 0.0 0.0 -1.0
vn 0.0 0.0 1.0
vn -1.0 0.0 0.0
vn 1.0 0.0 0.0
vn 0.0 -1.0 0.0
vn 0.0 1.0 0.0

# Faces
f 1//1 4//1 3//1 2//1
f 5//2 6//2 7//2 8//2
f 1//3 5//3 8//3 4//3
f 2//4 3//4 7//4 6//4
f 1//5 2//5 6//5 5//5
f 4//6 8//6 7//6 3//6
```



<br>

## 2.2. Rigidbodyの追加

物理的な動作（重力や力の影響）を与えたい場合、ゲームオブジェクトには**Rigidbody**コンポーネントを追加する必要があります。Rigidbodyが追加されたオブジェクトは、物理エンジンの影響を受けることができます。

- **Use Gravity**: このオプションを有効にすると、重力が適用されます。
- **Is Kinematic**: このオプションを有効にすると、Rigidbodyは物理エンジンの影響を受けず、手動で移動させることができます。

<br>

# 3. コリジョンイベント

Unityでは、コリジョンに関連するイベントを受け取るために特定のメソッドを使用します。これらのメソッドは、コリジョンの発生や終了を検出します。

## 3.1. OnCollisionEnter

```csharp
void OnCollisionEnter(Collision collision)
{
    // コリジョンが発生したときに呼ばれる
    Debug.Log("衝突したオブジェクト: " + collision.gameObject.name);
}
```

- 引数の`Collision`オブジェクトには、衝突したオブジェクトの情報が含まれます。衝突面の法線や衝突点、接触しているコライダーの情報を取得できます。

<br>

## 3.2. OnCollisionStay

```csharp
void OnCollisionStay(Collision collision)
{
    // コリジョンが継続している間呼ばれる
    Debug.Log("衝突中: " + collision.gameObject.name);
}
```

- オブジェクトが衝突し続けている場合に呼び出されます。

<br>

## 3.3. OnCollisionExit

```csharp
void OnCollisionExit(Collision collision)
{
    // コリジョンが終了したときに呼ばれる
    Debug.Log("衝突終了: " + collision.gameObject.name);
}
```

- コリジョンが終了したときに呼び出されます。

<br>

## 3.4. OnTriggerEnter

```csharp
void OnTriggerEnter(Collider other)
{
    // トリガーが発生したときに呼ばれる
    Debug.Log("トリガーに入ったオブジェクト: " + other.gameObject.name);
}
```

- トリガーのコライダーに他のオブジェクトが接触したときに呼び出されます。

<br>

## 3.5. OnTriggerStay / OnTriggerExit

これらのメソッドもそれぞれトリガーが継続している間や終了したときに呼び出されます。

<br>

### 4. コリジョンの最適化

- **Collidersの最適化**: できるだけシンプルな形状のColliderを使用することで、計算負荷を軽減できます。特にMesh Colliderは計算が重くなるため、必要な場合にのみ使用します。

- **Layerの設定**: `Layer Collision Matrix`を使用して、特定のレイヤー間の衝突を無視することができます。これにより、不要なコリジョン検出を回避できます。

- **Use Continuous Collision Detection**: 高速で移動するオブジェクトに対しては、Continuous Collision Detectionを有効にすることで、コリジョンをより正確に検出できます。


<br>

### 5. トラブルシューティング

- **コリジョンが発生しない**: ColliderやRigidbodyが正しく設定されているか確認します。特に、両方のオブジェクトにColliderが必要です。

- **OnCollisionメソッドが呼ばれない**: Rigidbodyが設定されているか、両方のオブジェクトのColliderが適切に設定されているか確認します。また、Triggerが有効になっている場合、OnCollisionメソッドは呼ばれません。

- **パフォーマンスの問題**: 多くのColliderやRigidbodyが存在する場合、パフォーマンスが低下する可能性があります。最適化のためにColliderの数を減らすことを検討してください。

<br>

### まとめ

Unityにおけるコリジョンは、ゲームオブジェクト同士の相互作用を管理する重要な機能です。ColliderやRigidbodyの設定、コリジョンイベントの利用、最適化技法を理解することで、物理的な挙動やゲームプレイを豊かにすることができます。コリジョンに関する正しい理解と設定は、スムーズで楽しいゲーム体験を実現するための基本です。