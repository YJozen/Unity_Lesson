スクリーン座標系における **z座標** は、カメラからの距離を示す情報です。

Unityでは、スクリーン座標系の **z座標** は「カメラからオブジェクトまでの距離」を表します。



<br>

# スクリーン座標系の理解

スクリーン座標系は通常、以下のように定義されます：
- **x座標**: 画面の横方向の位置（ピクセル単位）
- **y座標**: 画面の縦方向の位置（ピクセル単位）
- **z座標**: カメラからの距離（深度）

z座標が示す意味は以下の通りです：

- **`z > 0`**: オブジェクトがカメラの前方にあります。z座標が大きいほど、オブジェクトはカメラから遠くなります。
- **`z = 0`**: オブジェクトはカメラの近く、またはカメラに重なっている状態になります（通常、カメラの近距離クリッピング面上にあることを意味します）。
- **`z < 0`**: オブジェクトがカメラの背後にあります。この場合、オブジェクトはスクリーン上に描画されないことがあります（または描画されても正しい位置に表示されません）。

<br>

# `Camera.WorldToScreenPoint` の z座標

`Camera.WorldToScreenPoint` メソッドは、ワールド空間の3D位置（オブジェクトの位置）をスクリーン座標に変換します。このメソッドの返り値は `Vector3` で、x と y は画面上の位置を、z はカメラからの距離（深度）を示します。

例えば、`WorldToScreenPoint` を使ってワールド空間のオブジェクトのスクリーン座標を得るとき、z座標はそのオブジェクトがカメラからどれくらいの距離にあるかを示します。

```csharp
using UnityEngine;

public class ScreenPointZExample : MonoBehaviour
{
    public Camera mainCamera;

    void Update()
    {
        // ゲームオブジェクトのワールド座標をスクリーン座標に変換
        Vector3 screenPos = mainCamera.WorldToScreenPoint(transform.position);
        
        // スクリーン座標をコンソールに表示
        Debug.Log("スクリーン座標: " + screenPos);
        Debug.Log("z座標 (カメラからの距離): " + screenPos.z);
    }
}
```

このコードでは、オブジェクトのワールド位置をスクリーン座標に変換し、そのz座標（カメラからの距離）を表示しています。

- z座標が **正の値** であれば、オブジェクトはカメラの前にあり、スクリーンに表示されます。
- z座標が **0 に近い値** だと、オブジェクトはカメラに非常に近い、またはカメラのクリッピング範囲にあることを示します。
- z座標が **負の値** であれば、オブジェクトはカメラの背後にあり、スクリーンには表示されないか、間違った位置に表示されます。


<br>

# `Camera.ScreenToWorldPoint` の z座標

`ScreenToWorldPoint` メソッドはスクリーン座標をワールド座標に変換します。このメソッドに渡す **z座標** は、変換後のオブジェクトがカメラからどれくらい離れているべきかを指定します。

- `ScreenToWorldPoint` を使用してスクリーン座標をワールド座標に変換する際に、z座標を適切に設定することが非常に重要です。z座標が小さいと、オブジェクトがカメラに近い位置に、z座標が大きいとオブジェクトが遠くの位置に変換されます。

```csharp
using UnityEngine;

public class ScreenToWorldZExample : MonoBehaviour
{
    public Camera mainCamera;

    void Update()
    {
        // マウスのスクリーン座標をワールド座標に変換
        Vector3 screenPos = new Vector3(Input.mousePosition.x, Input.mousePosition.y, 10f);  // z座標を10に設定
        Vector3 worldPos = mainCamera.ScreenToWorldPoint(screenPos);
        
        // ワールド座標をコンソールに表示
        Debug.Log("ワールド座標: " + worldPos);
    }
}
```

このコードでは、マウス位置のスクリーン座標をワールド座標に変換しています。スクリーン座標のz値を `10f` に設定しているため、ワールド座標の計算時にその位置に基づいて変換が行われます。

<br>

# z座標の影響を受ける要素

1. **描画順序（Z-ordering）**:
   - スクリーン上でのオブジェクトの描画順序において、z座標が影響を与えることがあります。例えば、カメラに近いオブジェクトは遠いオブジェクトの前に描画されます。
   
2. **クリッピング**:
   - Unity ではカメラに近すぎたり、遠すぎたりするとオブジェクトが描画されなくなります。この範囲を **近距離クリッピング面** と **遠距離クリッピング面** で設定できます。
   - `z` 座標がカメラのクリッピング範囲外にあると、そのオブジェクトは描画されません。

<br>

# まとめ

- スクリーン座標の **z座標** は、カメラからオブジェクトまでの深度、つまり距離を示します。
- `Camera.WorldToScreenPoint` で得られるz座標は、オブジェクトがカメラからどれくらい遠いかを示し、これが小さすぎるとオブジェクトは画面外に描画されることがあります。
- `Camera.ScreenToWorldPoint` を使用する際、z座標はワールド座標を計算するための基準となる距離を指定します。

z座標の正しい理解と使い方が、UI や 3D オブジェクトの位置決定において非常に重要です。




<br>

---
---

<br>

# カメラの後ろにいるかの判定方法


<img src="images/unity-object-ui-position-6.png.avif" width="90%" alt="" title="">


カメラの後ろにターゲットがいるかどうかを判断する際に、`mainCamera.WorldToScreenPoint(target.position)` を使う方法と、`Vector3.Dot(targetDir, cameraDir) > 0` を使う方法には、根本的な違いがあります。それぞれの方法が何をしているかを詳しく解説します。

# 1. `mainCamera.WorldToScreenPoint(target.position)` の使用

`Camera.WorldToScreenPoint` は、ワールド座標系でのターゲットの位置をスクリーン座標系に変換する関数です。この関数はターゲットが **画面内にあるかどうか** を確認するために主に使われますが、z座標がターゲットとカメラとの相対的な距離を表すため、この情報も用いてカメラの前後関係を判断できます。

## 使用方法
```csharp
Vector3 screenPoint = mainCamera.WorldToScreenPoint(target.position);
bool isBehind = screenPoint.z < 0;
```

- **z座標**: `WorldToScreenPoint` で得られる `z` 座標は、ターゲットがカメラから **前か後ろか** に位置するかを示します。
  - `screenPoint.z > 0`: ターゲットはカメラの前方にあり、画面に映る。
  - `screenPoint.z < 0`: ターゲットはカメラの背後にあり、画面には映らない。

この方法は **画面表示の有無** を基にターゲットの前後を判断するのに便利です。スクリーン座標を使うため、**カメラの視点に依存して** おり、実際にターゲットがカメラに対して前後に位置しているかを計測します。

<br>

# 2. `Vector3.Dot(targetDir, cameraDir) > 0` の使用

`Vector3.Dot` を使う方法は、ターゲットとカメラの向きに関する **方向ベクトルの関係** を確認する方法です。ドット積を使うことで、ターゲットがカメラの前方か後方かを計算します。

## 使用方法
```csharp
Vector3 cameraDir = mainCamera.transform.forward;
Vector3 targetDir = target.position - mainCamera.transform.position;
bool isFront = Vector3.Dot(targetDir, cameraDir) > 0;
```

- `Vector3.Dot(targetDir, cameraDir) > 0`: ターゲットがカメラの **前方** にいる場合、ドット積は正になります。
  - 正の値: ターゲットがカメラの前方にいる。
  - 負の値: ターゲットがカメラの後方にいる。

この方法は **物理的な位置関係** を基にターゲットがカメラの前後に位置するかを判断するため、カメラの画面内外に依存せず、ターゲットがカメラの視野内かどうかに関係なく前後をチェックできます。

<br>

# 比較：スクリーン座標とドット積の違い

| 特性 | `WorldToScreenPoint` (スクリーン座標) | `Vector3.Dot` (方向ベクトル) |
|------|---------------------------------------|---------------------------------|
| **前後関係の判断** | カメラからの距離による、画面内外の確認 | カメラとターゲットの向きによる前後の確認 |
| **依存関係** | カメラの視点（画面に映るかどうか）に依存 | カメラの方向ベクトルに依存、画面外でも判定可能 |
| **結果の確認方法** | `z座標 > 0` で前方、`z座標 < 0` で後方 | `Dot` 結果が正なら前方、負なら後方 |
| **主な用途** | 画面内でのオブジェクトの前後関係確認 | 3D空間での前後関係の判定 |

<br>

<br>

# どちらを使うべきか？

- **`mainCamera.WorldToScreenPoint`** を使う方法は、ターゲットが画面内に映っているかどうか、そしてその前後を確認したい場合に有効です。カメラの視点によってオブジェクトが表示されるかどうかが関連するため、画面の描画状態に基づく判定になります。
- **`Vector3.Dot`** を使う方法は、ターゲットがカメラの前方にいるか後方にいるかを **ワールド空間での位置関係に基づいて** 判定するため、画面内外に関係なくターゲットがカメラの前後に位置しているかを知りたい場合に有効です。

# 実際の選択基準

- **スクリーン座標での前後関係**: 画面に表示されているオブジェクトの前後を確認したい場合や、2D UI要素のように画面座標に基づいて動作を判断したい場合に適しています。

- **ドット積での前後関係**: 3D空間でカメラとターゲットの位置関係を基に判定したい場合に、ターゲットがカメラの向きに対して前後に位置するかを知りたいときに適しています。







